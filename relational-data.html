<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>14 Relational data | R for Data Science (2e)</title>
<meta name="author" content="Hadley Wickham and Garrett Grolemund">
<meta name="description" content="14.1 Introduction It’s rare that a data analysis involves only a single data frame. Typically you have many data frames, and you must combine them to answer the questions that you’re interested...">
<meta name="generator" content="bookdown 0.23 with bs4_book()">
<meta property="og:title" content="14 Relational data | R for Data Science (2e)">
<meta property="og:type" content="book">
<meta property="og:url" content="https://r4ds.had.co.nz/relational-data.html">
<meta property="og:image" content="https://r4ds.had.co.nz//cover.png">
<meta property="og:description" content="14.1 Introduction It’s rare that a data analysis involves only a single data frame. Typically you have many data frames, and you must combine them to answer the questions that you’re interested...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="14 Relational data | R for Data Science (2e)">
<meta name="twitter:site" content="@hadley">
<meta name="twitter:description" content="14.1 Introduction It’s rare that a data analysis involves only a single data frame. Typically you have many data frames, and you must combine them to answer the questions that you’re interested...">
<meta name="twitter:image" content="https://r4ds.had.co.nz//cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.10/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-115082821-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R for Data Science (2e)</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface-to-the-second-edition.html">Preface to the second edition</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Whole game</li>
<li><a class="" href="explore-intro.html"><span class="header-section-number">2</span> Introduction</a></li>
<li><a class="" href="data-visualisation.html"><span class="header-section-number">3</span> Data visualisation</a></li>
<li><a class="" href="workflow-basics.html"><span class="header-section-number">4</span> Workflow: basics</a></li>
<li><a class="" href="data-transform.html"><span class="header-section-number">5</span> Data transformation</a></li>
<li><a class="" href="data-tidy.html"><span class="header-section-number">6</span> Data tidying</a></li>
<li><a class="" href="workflow-pipes.html"><span class="header-section-number">7</span> Workflow: pipes</a></li>
<li><a class="" href="data-import.html"><span class="header-section-number">8</span> Data import</a></li>
<li><a class="" href="workflow-scripts.html"><span class="header-section-number">9</span> Workflow: scripts</a></li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">10</span> Exploratory Data Analysis</a></li>
<li><a class="" href="workflow-projects.html"><span class="header-section-number">11</span> Workflow: projects</a></li>
<li class="book-part">Transform</li>
<li><a class="" href="data-types-intro.html"><span class="header-section-number">12</span> Introduction</a></li>
<li><a class="" href="tibbles.html"><span class="header-section-number">13</span> Tibbles</a></li>
<li><a class="active" href="relational-data.html"><span class="header-section-number">14</span> Relational data</a></li>
<li><a class="" href="vector-tools.html"><span class="header-section-number">15</span> Vector tools</a></li>
<li><a class="" href="logicals-numbers.html"><span class="header-section-number">16</span> Logicals and numbers</a></li>
<li><a class="" href="missing-values.html"><span class="header-section-number">17</span> Missing values</a></li>
<li><a class="" href="strings.html"><span class="header-section-number">18</span> Strings</a></li>
<li><a class="" href="regular-expressions.html"><span class="header-section-number">19</span> Regular expressions</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">20</span> Factors</a></li>
<li><a class="" href="dates-and-times.html"><span class="header-section-number">21</span> Dates and times</a></li>
<li><a class="" href="column-wise.html"><span class="header-section-number">22</span> Column-wise operations</a></li>
<li class="book-part">Import</li>
<li><a class="" href="import-intro.html"><span class="header-section-number">23</span> Introduction</a></li>
<li><a class="" href="import-rectangular.html"><span class="header-section-number">24</span> Rectangular data</a></li>
<li><a class="" href="import-spreadsheets.html"><span class="header-section-number">25</span> Spreadsheets</a></li>
<li><a class="" href="import-databases.html"><span class="header-section-number">26</span> Databases</a></li>
<li><a class="" href="import-webscrape.html"><span class="header-section-number">27</span> Web scraping</a></li>
<li><a class="" href="import-other.html"><span class="header-section-number">28</span> Other types of data</a></li>
<li class="book-part">Tidy</li>
<li><a class="" href="wrangle-intro.html"><span class="header-section-number">29</span> Introduction</a></li>
<li><a class="" href="list-columns.html"><span class="header-section-number">30</span> List columns</a></li>
<li><a class="" href="rectangle-data.html"><span class="header-section-number">31</span> Data rectangling</a></li>
<li class="book-part">Program</li>
<li><a class="" href="program-intro.html"><span class="header-section-number">32</span> Introduction</a></li>
<li><a class="" href="pipes.html"><span class="header-section-number">33</span> Pipes</a></li>
<li><a class="" href="functions.html"><span class="header-section-number">34</span> Functions</a></li>
<li><a class="" href="vectors.html"><span class="header-section-number">35</span> Vectors</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">36</span> Iteration</a></li>
<li><a class="" href="programming-with-strings.html"><span class="header-section-number">37</span> Programming with strings</a></li>
<li class="book-part">Communicate</li>
<li><a class="" href="communicate-intro.html"><span class="header-section-number">38</span> Introduction</a></li>
<li><a class="" href="r-markdown.html"><span class="header-section-number">39</span> R Markdown</a></li>
<li><a class="" href="graphics-for-communication.html"><span class="header-section-number">40</span> Graphics for communication</a></li>
<li><a class="" href="r-markdown-formats.html"><span class="header-section-number">41</span> R Markdown formats</a></li>
<li><a class="" href="r-markdown-workflow.html"><span class="header-section-number">42</span> R Markdown workflow</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/r4ds">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="relational-data" class="section level1" number="14">
<h1>
<span class="header-section-number">14</span> Relational data<a class="anchor" aria-label="anchor" href="#relational-data"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-7" class="section level2" number="14.1">
<h2>
<span class="header-section-number">14.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-7"><i class="fas fa-link"></i></a>
</h2>
<p>It’s rare that a data analysis involves only a single data frame.
Typically you have many data frames, and you must combine them to answer the questions that you’re interested in.
Collectively, multiple data frames are called <strong>relational data</strong> because it is the relations, not just the individual datasets, that are important.</p>
<p>Relations are always defined between a pair of data frames.
All other relations are built up from this simple idea: the relations of three or more data frames are always a property of the relations between each pair.
Sometimes both elements of a pair can be the same data frame!
This is needed if, for example, you have a data frame of people, and each person has a reference to their parents.</p>
<p>To work with relational data you need verbs that work with pairs of data frames.
There are three families of verbs designed to work with relational data:</p>
<ul>
<li><p><strong>Mutating joins</strong>, which add new variables to one data frame from matching observations in another.</p></li>
<li><p><strong>Filtering joins</strong>, which filter observations from one data frame based on whether or not they match an observation in the other data frame.</p></li>
<li><p><strong>Set operations</strong>, which treat observations as if they were set elements.</p></li>
</ul>
<p>The most common place to find relational data is in a <em>relational</em> database management system (or RDBMS), a term that encompasses almost all modern databases.
If you’ve used a database before, you’ve almost certainly used SQL.
If so, you should find the concepts in this chapter familiar, although their expression in dplyr is a little different.
One other major terminology difference between databases and R is that what we generally refer to as data frames in R while the same concept is referred to as “table” in databases.
Hence you’ll see references to one-table and two-table verbs in dplyr documentation.
Generally, dplyr is a little easier to use than SQL because dplyr is specialised to do data analysis: it makes common data analysis operations easier, at the expense of making it more difficult to do other things that aren’t commonly needed for data analysis.</p>
<div id="prerequisites-7" class="section level3" number="14.1.1">
<h3>
<span class="header-section-number">14.1.1</span> Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites-7"><i class="fas fa-link"></i></a>
</h3>
<p>We will explore relational data from <code>nycflights13</code> using the two-table verbs from dplyr.</p>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="nycflights13-relational" class="section level2" number="14.2">
<h2>
<span class="header-section-number">14.2</span> nycflights13<a class="anchor" aria-label="anchor" href="#nycflights13-relational"><i class="fas fa-link"></i></a>
</h2>
<p>We will use the nycflights13 package to learn about relational data.
nycflights13 contains five tibbles : <code>airlines</code>, <code>airports</code>, <code>weather</code> and <code>planes</code> which are all related to the <code>flights</code> data frame that you used in Chapter <a href="data-transform.html#data-transform">5</a> on data transformation:</p>
<ul>
<li>
<p><code>airlines</code> lets you look up the full carrier name from its abbreviated code:</p>
<div class="sourceCode" id="cb235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airlines</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 16 x 2&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mname&lt;U+2029&gt;[22m                    </span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m                   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m 9E      Endeavor Air Inc.       </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m AA      American Airlines Inc.  </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m AS      Alaska Airlines Inc.    </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m B6      JetBlue Airways         </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m DL      Delta Air Lines Inc.    </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m EV      ExpressJet Airlines Inc.</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 10 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
</li>
<li>
<p><code>airports</code> gives information about each airport, identified by the <code>faa</code> airport code:</p>
<div class="sourceCode" id="cb236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airports</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 1,458 x 8&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[1mfaa&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mname&lt;U+2029&gt;[22m                             &lt;U+2029&gt;[1mlat&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mlon&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1malt&lt;U+2029&gt;[22m    &lt;U+2029&gt;[1mtz&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdst&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mtzone&lt;U+2029&gt;[22m      </span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m                          &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m      </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m 04G   Lansdowne Airport               41.1 -&lt;U+2029&gt;[31m80&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m044    -&lt;U+2029&gt;[31m5&lt;U+2029&gt;[39m A     America/Ne~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m 06A   Moton Field Municipal Airport   32.5 -&lt;U+2029&gt;[31m85&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m7&lt;U+2029&gt;[39m   264    -&lt;U+2029&gt;[31m6&lt;U+2029&gt;[39m A     America/Ch~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m 06C   Schaumburg Regional             42.0 -&lt;U+2029&gt;[31m88&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m1&lt;U+2029&gt;[39m   801    -&lt;U+2029&gt;[31m6&lt;U+2029&gt;[39m A     America/Ch~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m 06N   Randall Airport                 41.4 -&lt;U+2029&gt;[31m74&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m4&lt;U+2029&gt;[39m   523    -&lt;U+2029&gt;[31m5&lt;U+2029&gt;[39m A     America/Ne~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m 09J   Jekyll Island Airport           31.1 -&lt;U+2029&gt;[31m81&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m4&lt;U+2029&gt;[39m    11    -&lt;U+2029&gt;[31m5&lt;U+2029&gt;[39m A     America/Ne~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m 0A9   Elizabethton Municipal Airport  36.4 -&lt;U+2029&gt;[31m82&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m593    -&lt;U+2029&gt;[31m5&lt;U+2029&gt;[39m A     America/Ne~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 1,452 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
</li>
<li>
<p><code>planes</code> gives information about each plane, identified by its <code>tailnum</code>:</p>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">planes</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 3,322 x 9&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mtype&lt;U+2029&gt;[22m           &lt;U+2029&gt;[1mmanufacturer&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mmodel&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mengines&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mseats&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mspeed&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mengine&lt;U+2029&gt;[22m </span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m          &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m          &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m    &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m N10156   &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m004 Fixed wing mu~ EMBRAER        EMB-1~       2    55    &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m Turbo-~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m N102UW   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m998 Fixed wing mu~ AIRBUS INDUST~ A320-~       2   182    &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m Turbo-~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m N103US   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m999 Fixed wing mu~ AIRBUS INDUST~ A320-~       2   182    &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m Turbo-~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m N104UW   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m999 Fixed wing mu~ AIRBUS INDUST~ A320-~       2   182    &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m Turbo-~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m N10575   &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m002 Fixed wing mu~ EMBRAER        EMB-1~       2    55    &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m Turbo-~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m N105UW   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m999 Fixed wing mu~ AIRBUS INDUST~ A320-~       2   182    &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m Turbo-~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 3,316 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
</li>
<li>
<p><code>weather</code> gives the weather at each NYC airport for each hour:</p>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">weather</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 26,115 x 15&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mtemp&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mdewp&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mhumid&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mwind_dir&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mwind_speed&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mwind_gust&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m    &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m      &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m     &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m EWR     &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     1  39.0  26.1  59.4      270      10.4         &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m EWR     &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     2  39.0  27.0  61.6      250       8.06        &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m EWR     &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     3  39.0  28.0  64.4      240      11.5         &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m EWR     &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     4  39.9  28.0  62.2      250      12.7         &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m EWR     &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5  39.0  28.0  64.4      260      12.7         &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m EWR     &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     6  37.9  28.0  67.2      240      11.5         &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 26,109 more rows, and 4 more variables: &lt;U+2029&gt;[1mprecip&lt;U+2029&gt;[22m &lt;dbl&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mpressure&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mvisib&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mtime_hour&lt;U+2029&gt;[22m &lt;dttm&gt;&lt;U+2029&gt;[39m</span>NA</code></pre></div>
</li>
</ul>
<p>One way to show the relationships between the different data frames is with a diagram:</p>
<div class="inline-figure"><img src="diagrams/relational-nycflights.png" title="Diagram of the relationships between airports, planes, flights, weather, and airlines datasets from the nycflights13 package. The faa variable in the airports data frame is connected to the origin and dest variables in the flights data frame. The tailnum variable in the planes data frame is connected to the tailnum variable in flights. The year, month, day, hour, and origin variables are connected to the variables with the same name in the flights data frame. And finally the carrier variables in the airlines data frame is connected to the carrier variable in the flights data frame. There are no direct connections between airports, planes, airlines, and weather data frames." alt="Diagram of the relationships between airports, planes, flights, weather, and airlines datasets from the nycflights13 package. The faa variable in the airports data frame is connected to the origin and dest variables in the flights data frame. The tailnum variable in the planes data frame is connected to the tailnum variable in flights. The year, month, day, hour, and origin variables are connected to the variables with the same name in the flights data frame. And finally the carrier variables in the airlines data frame is connected to the carrier variable in the flights data frame. There are no direct connections between airports, planes, airlines, and weather data frames." width="70%" style="display: block; margin: auto;"></div>
<p>This diagram is a little overwhelming, but it’s simple compared to some you’ll see in the wild!
The key to understanding diagrams like this is to remember each relation always concerns a pair of data frames.
You don’t need to understand the whole thing; you just need to understand the chain of relations between the data frames that you are interested in.</p>
<p>For nycflights13:</p>
<ul>
<li><p><code>flights</code> connects to <code>planes</code> via a single variable, <code>tailnum</code>.</p></li>
<li><p><code>flights</code> connects to <code>airlines</code> through the <code>carrier</code> variable.</p></li>
<li><p><code>flights</code> connects to <code>airports</code> in two ways: via the <code>origin</code> and <code>dest</code> variables.</p></li>
<li><p><code>flights</code> connects to <code>weather</code> via <code>origin</code> (the location), and <code>year</code>, <code>month</code>, <code>day</code> and <code>hour</code> (the time).</p></li>
</ul>
<div id="exercises-23" class="section level3" number="14.2.1">
<h3>
<span class="header-section-number">14.2.1</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-23"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Imagine you wanted to draw (approximately) the route each plane flies from its origin to its destination.
What variables would you need?
What data frames would you need to combine?</p></li>
<li><p>I forgot to draw the relationship between <code>weather</code> and <code>airports</code>.
What is the relationship and how should it appear in the diagram?</p></li>
<li><p><code>weather</code> only contains information for the origin (NYC) airports.
If it contained weather records for all airports in the USA, what additional relation would it define with <code>flights</code>?</p></li>
</ol>
</div>
</div>
<div id="keys" class="section level2" number="14.3">
<h2>
<span class="header-section-number">14.3</span> Keys<a class="anchor" aria-label="anchor" href="#keys"><i class="fas fa-link"></i></a>
</h2>
<p>The variables used to connect each pair of data frames are called <strong>keys</strong>.
A key is a variable (or set of variables) that uniquely identifies an observation.
In simple cases, a single variable is sufficient to identify an observation.
For example, each plane is uniquely identified by its <code>tailnum</code>.
In other cases, multiple variables may be needed.
For example, to identify an observation in <code>weather</code> you need five variables: <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code>, and <code>origin</code>.</p>
<p>There are two types of keys:</p>
<ul>
<li><p>A <strong>primary key</strong> uniquely identifies an observation in its own data frame.
For example, <code>planes$tailnum</code> is a primary key because it uniquely identifies each plane in the <code>planes</code> data frame.</p></li>
<li><p>A <strong>foreign key</strong> uniquely identifies an observation in another data frame.
For example, <code>flights$tailnum</code> is a foreign key because it appears in the <code>flights</code> data frame where it matches each flight to a unique plane.</p></li>
</ul>
<p>A variable can be both a primary key <em>and</em> a foreign key.
For example, <code>origin</code> is part of the <code>weather</code> primary key, and is also a foreign key for the <code>airports</code> data frame.</p>
<p>Once you’ve identified the primary keys in your data frames, it’s good practice to verify that they do indeed uniquely identify each observation.
One way to do that is to <code>count()</code> the primary keys and look for entries where <code>n</code> is greater than one:</p>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">planes</span> <span class="op">%&gt;%</span> 
  <span class="fu">count</span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 0 x 2&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 2 variables: &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;chr&gt;, &lt;U+2029&gt;[1mn&lt;U+2029&gt;[22m &lt;int&gt;&lt;U+2029&gt;[39m</span>NA<span class="va">weather</span> <span class="op">%&gt;%</span> 
  <span class="fu">count</span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">hour</span>, <span class="va">origin</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 3 x 6&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m     &lt;U+2029&gt;[1mn&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013    11     3     1 EWR        2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013    11     3     1 JFK        2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013    11     3     1 LGA        2</span>NA</code></pre></div>
<p>Sometimes a data frame doesn’t have an explicit primary key: each row is an observation, but no combination of variables reliably identifies it.
For example, what’s the primary key in the <code>flights</code> data frame?
You might think it would be the date plus the flight or tail number, but neither of those are unique:</p>
<div class="sourceCode" id="cb240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights</span> <span class="op">%&gt;%</span> 
  <span class="fu">count</span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">flight</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 29,768 x 5&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mflight&lt;U+2029&gt;[22m     &lt;U+2029&gt;[1mn&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      1     2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      3     2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      4     2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     11     3</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     15     2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     21     2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 29,762 more rows&lt;U+2029&gt;[39m</span>NA<span class="va">flights</span> <span class="op">%&gt;%</span> 
  <span class="fu">count</span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">tailnum</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 64,928 x 5&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m     &lt;U+2029&gt;[1mn&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1 N0EGMQ      2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1 N11189      2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1 N11536      2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1 N11544      3</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1 N11551      2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1 N12540      2</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 64,922 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<p>When starting to work with this data, I had naively assumed that each flight number would be only used once per day: that would make it much easier to communicate problems with a specific flight.
Unfortunately that is not the case!
If a data frame lacks a primary key, it’s sometimes useful to add one with <code>mutate()</code> and <code>row_number()</code>.
That makes it easier to match observations if you’ve done some filtering and want to check back in with the original data.
This is called a <strong>surrogate key</strong>.</p>
<p>A primary key and the corresponding foreign key in another data frame form a <strong>relation</strong>.
Relations are typically one-to-many.
For example, each flight has one plane, but each plane has many flights.
In other data, you’ll occasionally see a 1-to-1 relationship.
You can think of this as a special case of 1-to-many.
You can model many-to-many relations with a many-to-1 relation plus a 1-to-many relation.
For example, in this data there’s a many-to-many relationship between airlines and airports: each airline flies to many airports; each airport hosts many airlines.</p>
<div id="exercises-24" class="section level3" number="14.3.1">
<h3>
<span class="header-section-number">14.3.1</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-24"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Add a surrogate key to <code>flights</code>.</p></li>
<li><p>We know that some days of the year are “special”, and fewer people than usual fly on them.
How might you represent that data as a data frame?
What would be the primary keys of that data frame?
How would it connect to the existing data frames?</p></li>
<li>
<p>Identify the keys in the following datasets</p>
<ol style="list-style-type: lower-alpha">
<li><code><a href="https://rdrr.io/pkg/Lahman/man/Batting.html">Lahman::Batting</a></code></li>
<li><code><a href="https://rdrr.io/pkg/babynames/man/babynames.html">babynames::babynames</a></code></li>
<li><code>nasaweather::atmos</code></li>
<li><code>fueleconomy::vehicles</code></li>
<li><code><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">ggplot2::diamonds</a></code></li>
</ol>
<p>(You might need to install some packages and read some documentation.)</p>
</li>
<li>
<p>Draw a diagram illustrating the connections between the <code>Batting</code>, <code>People</code>, and <code>Salaries</code> data frames in the Lahman package.
Draw another diagram that shows the relationship between <code>People</code>, <code>Managers</code>, <code>AwardsManagers</code>.</p>
<p>How would you characterise the relationship between the <code>Batting</code>, <code>Pitching</code>, and <code>Fielding</code> data frames?</p>
</li>
</ol>
</div>
</div>
<div id="mutating-joins" class="section level2" number="14.4">
<h2>
<span class="header-section-number">14.4</span> Mutating joins<a class="anchor" aria-label="anchor" href="#mutating-joins"><i class="fas fa-link"></i></a>
</h2>
<p>The first tool we’ll look at for combining a pair of data frames is the <strong>mutating join</strong>.
A mutating join allows you to combine variables from two data frames.
It first matches observations by their keys, then copies across variables from one data frame to the other.</p>
<p>Like <code>mutate()</code>, the join functions add variables to the right, so if you have a lot of variables already, the new variables won’t get printed out.
For these examples, we’ll make it easier to see what’s going on in the examples by creating a narrower dataset:</p>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights2</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">year</span><span class="op">:</span><span class="va">day</span>, <span class="va">hour</span>, <span class="va">origin</span>, <span class="va">dest</span>, <span class="va">tailnum</span>, <span class="va">carrier</span><span class="op">)</span>
<span class="va">flights2</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 336,776 x 8&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdest&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    IAH   N14228  UA     </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 LGA    IAH   N24211  UA     </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    MIA   N619AA  AA     </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    BQN   N804JB  B6     </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     6 LGA    ATL   N668DN  DL     </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    ORD   N39463  UA     </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 336,770 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<p>(Remember, when you’re in RStudio, you can also use <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code> to avoid this problem.)</p>
<p>Imagine you want to add the full airline name to the <code>flights2</code> data.
You can combine the <code>airlines</code> and <code>flights2</code> data frames with <code>left_join()</code>:</p>
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights2</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">origin</span>, <span class="op">-</span><span class="va">dest</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">left_join</span><span class="op">(</span><span class="va">airlines</span>, by <span class="op">=</span> <span class="st">"carrier"</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 336,776 x 7&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mname&lt;U+2029&gt;[22m                  </span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m                 </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N14228  UA      United Air Lines Inc. </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N24211  UA      United Air Lines Inc. </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N619AA  AA      American Airlines Inc.</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N804JB  B6      JetBlue Airways       </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     6 N668DN  DL      Delta Air Lines Inc.  </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N39463  UA      United Air Lines Inc. </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 336,770 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<p>The result of joining airlines to flights2 is an additional variable: <code>name</code>.
This is why I call this type of join a mutating join.
In this case, you could have got to the same place using <code>mutate()</code> and R’s base subsetting:</p>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights2</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">origin</span>, <span class="op">-</span><span class="va">dest</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>name <span class="op">=</span> <span class="va">airlines</span><span class="op">$</span><span class="va">name</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">carrier</span>, <span class="va">airlines</span><span class="op">$</span><span class="va">carrier</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 336,776 x 7&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mname&lt;U+2029&gt;[22m                  </span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m                 </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N14228  UA      United Air Lines Inc. </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N24211  UA      United Air Lines Inc. </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N619AA  AA      American Airlines Inc.</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N804JB  B6      JetBlue Airways       </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     6 N668DN  DL      Delta Air Lines Inc.  </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 N39463  UA      United Air Lines Inc. </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 336,770 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<p>But this is hard to generalise when you need to match multiple variables, and takes close reading to figure out the overall intent.</p>
<p>The following sections explain, in detail, how mutating joins work.
You’ll start by learning a useful visual representation of joins.
We’ll then use that to explain the four mutating join functions: the inner join, and the three outer joins.
When working with real data, keys don’t always uniquely identify observations, so next we’ll talk about what happens when there isn’t a unique match.
Finally, you’ll learn how to tell dplyr which variables are the keys for a given join.</p>
<div id="understanding-joins" class="section level3" number="14.4.1">
<h3>
<span class="header-section-number">14.4.1</span> Understanding joins<a class="anchor" aria-label="anchor" href="#understanding-joins"><i class="fas fa-link"></i></a>
</h3>
<p>To help you learn how joins work, I’m going to use a visual representation:</p>
<div class="inline-figure"><img src="diagrams/join-setup.png" title="x and y are two data frames with 2 columns and 3 rows each. The first column in each is the key and the second is the value. The contents of these data frames are given in the subsequent code chunk." alt="x and y are two data frames with 2 columns and 3 rows each. The first column in each is the key and the second is the value. The contents of these data frames are given in the subsequent code chunk." width="118" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span>
  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_x</span>,
     <span class="fl">1</span>, <span class="st">"x1"</span>,
     <span class="fl">2</span>, <span class="st">"x2"</span>,
     <span class="fl">3</span>, <span class="st">"x3"</span>
<span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span>
  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_y</span>,
     <span class="fl">1</span>, <span class="st">"y1"</span>,
     <span class="fl">2</span>, <span class="st">"y2"</span>,
     <span class="fl">4</span>, <span class="st">"y3"</span>
<span class="op">)</span></code></pre></div>
<p>The coloured column represents the “key” variable: these are used to match the rows between the data frames.
The grey column represents the “value” column that is carried along for the ride.
In these examples I’ll show a single key variable, but the idea generalises in a straightforward way to multiple keys and multiple values.</p>
<p>A join is a way of connecting each row in <code>x</code> to zero, one, or more rows in <code>y</code>.
The following diagram shows each potential match as an intersection of a pair of lines.</p>
<div class="inline-figure"><img src="diagrams/join-setup2.png" title="x and y data frames placed next to each other. with the key variable moved up front in y so that the key variable in x and key variable in y appear next to each other." alt="x and y data frames placed next to each other. with the key variable moved up front in y so that the key variable in x and key variable in y appear next to each other." width="166" style="display: block; margin: auto;"></div>
<p>(If you look closely, you might notice that we’ve switched the order of the key and value columns in <code>x</code>. This is to emphasise that joins match based on the key; the value is just carried along for the ride.)</p>
<p>In an actual join, matches will be indicated with dots.
The number of dots = the number of matches = the number of rows in the output.</p>
<div class="inline-figure"><img src="diagrams/join-inner.png" title="Keys 1 and 2 in x and y data frames are matched and indicated with lines joining these rows with dot in the middle. Hence, there are two dots in this diagram. The resulting joined data frame has two rows and 3 columns: key, val_x, and val_y. Values in the key column are 1 and 2 (the matched values)." alt="Keys 1 and 2 in x and y data frames are matched and indicated with lines joining these rows with dot in the middle. Hence, there are two dots in this diagram. The resulting joined data frame has two rows and 3 columns: key, val_x, and val_y. Values in the key column are 1 and 2 (the matched values)." width="338" style="display: block; margin: auto;"></div>
</div>
<div id="inner-join" class="section level3" number="14.4.2">
<h3>
<span class="header-section-number">14.4.2</span> Inner join<a class="anchor" aria-label="anchor" href="#inner-join"><i class="fas fa-link"></i></a>
</h3>
<p>The simplest type of join is the <strong>inner join</strong>.
An inner join matches pairs of observations whenever their keys are equal:</p>
<div class="inline-figure"><img src="diagrams/join-inner.png" title="Keys 1 and 2 in x and y data frames are matched and indicated with lines joining these rows with dot in the middle. Hence, there are two dots in this diagram. The resulting joined data frame has two rows and 3 columns: key, val_x, and val_y. Values in the key column are 1 and 2 (the matched values)." alt="Keys 1 and 2 in x and y data frames are matched and indicated with lines joining these rows with dot in the middle. Hence, there are two dots in this diagram. The resulting joined data frame has two rows and 3 columns: key, val_x, and val_y. Values in the key column are 1 and 2 (the matched values)." width="338" style="display: block; margin: auto;"></div>
<p>(To be precise, this is an inner <strong>equijoin</strong> because the keys are matched using the equality operator. Since most joins are equijoins we usually drop that specification.)</p>
<p>The output of an inner join is a new data frame that contains the key, the x values, and the y values.
We use <code>by</code> to tell dplyr which variable is the key:</p>
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">%&gt;%</span> 
  <span class="fu">inner_join</span><span class="op">(</span><span class="va">y</span>, by <span class="op">=</span> <span class="st">"key"</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 2 x 3&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;     &lt;U+2029&gt;[1mkey&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mval_x&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mval_y&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m     1 x1    y1   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m     2 x2    y2</span>NA</code></pre></div>
<p>The most important property of an inner join is that unmatched rows are not included in the result.
This means that generally inner joins are usually not appropriate for use in analysis because it’s too easy to lose observations.</p>
</div>
<div id="outer-join" class="section level3" number="14.4.3">
<h3>
<span class="header-section-number">14.4.3</span> Outer joins<a class="anchor" aria-label="anchor" href="#outer-join"><i class="fas fa-link"></i></a>
</h3>
<p>An inner join keeps observations that appear in both data frames.
An <strong>outer join</strong> keeps observations that appear in at least one of the data frames.
There are three types of outer joins:</p>
<ul>
<li>A <strong>left join</strong> keeps all observations in <code>x</code>.</li>
<li>A <strong>right join</strong> keeps all observations in <code>y</code>.</li>
<li>A <strong>full join</strong> keeps all observations in <code>x</code> and <code>y</code>.</li>
</ul>
<p>These joins work by adding an additional “virtual” observation to each data frame.
This observation has a key that always matches (if no other key matches), and a value filled with <code>NA</code>.</p>
<p>Graphically, that looks like:</p>
<div class="inline-figure"><img src="diagrams/join-outer.png" title="Three diagrams for left, right, and full joins. In each diagram data frame x is on the left and y is on the right. The result of the join is always a data frame with three columns (key, val_x, and val_y). Left join: keys 1 and 2 from x are matched to those in y, key 3 is also carried along to the joined result since it's on the left data frame, but key 4 from y is not carried along since it's on the right but not on the left. The result is a data frame with 3 rows: keys 1, 2, and 3, all values from val_x, and the corresponding values from val_y for keys 1 and 2 with an NA for key 3, val_y. Right join: keys 1 and 2 from x are matched to those in y, key 4 is also carried along to the joined result since it's on the right data frame, but key 3 from x is not carried along since it's on the left but not on the right. The result is a data frame with 3 rows: keys 1, 2, and 4, all values from val_y, and the corresponding values from val_x for keys 1 and 2 with an NA for key 4, val_x. Full join: The resulting data frame has 4 rows: keys 1, 2, 3, and 4 with all values from val_x and val_y, however key 2, val_y and key 4, val_x are NAs since those keys aren't present in their respective data frames." alt="Three diagrams for left, right, and full joins. In each diagram data frame x is on the left and y is on the right. The result of the join is always a data frame with three columns (key, val_x, and val_y). Left join: keys 1 and 2 from x are matched to those in y, key 3 is also carried along to the joined result since it's on the left data frame, but key 4 from y is not carried along since it's on the right but not on the left. The result is a data frame with 3 rows: keys 1, 2, and 3, all values from val_x, and the corresponding values from val_y for keys 1 and 2 with an NA for key 3, val_y. Right join: keys 1 and 2 from x are matched to those in y, key 4 is also carried along to the joined result since it's on the right data frame, but key 3 from x is not carried along since it's on the left but not on the right. The result is a data frame with 3 rows: keys 1, 2, and 4, all values from val_y, and the corresponding values from val_x for keys 1 and 2 with an NA for key 4, val_x. Full join: The resulting data frame has 4 rows: keys 1, 2, 3, and 4 with all values from val_x and val_y, however key 2, val_y and key 4, val_x are NAs since those keys aren't present in their respective data frames." width="355" style="display: block; margin: auto;"></div>
<p>The most commonly used join is the left join: you use this whenever you look up additional data from another data frame, because it preserves the original observations even when there isn’t a match.
The left join should be your default join: use it unless you have a strong reason to prefer one of the others.</p>
<p>Another way to depict the different types of joins is with a Venn diagram:</p>
<div class="inline-figure"><img src="diagrams/join-venn.png" title="Venn diagrams for inner, full, left, and right joins. Each join represented with two intersecting circles representing data frames x and y, with x on the right and y on the left. Shading indicates the result of the join. Inner join: Only intersection is shaded. Full join: Everything is shaded. Left join: Only x is shaded, but not the area in y that doesn't intersect with x. Right join: Only y is shaded, but not the area in x that doesn't intersect with y." alt="Venn diagrams for inner, full, left, and right joins. Each join represented with two intersecting circles representing data frames x and y, with x on the right and y on the left. Shading indicates the result of the join. Inner join: Only intersection is shaded. Full join: Everything is shaded. Left join: Only x is shaded, but not the area in y that doesn't intersect with x. Right join: Only y is shaded, but not the area in x that doesn't intersect with y." width="551" style="display: block; margin: auto;"></div>
<p>However, this is not a great representation.
It might jog your memory about which join preserves the observations in which data frame, but it suffers from a major limitation: a Venn diagram can’t show what happens when keys don’t uniquely identify an observation.</p>
</div>
<div id="join-matches" class="section level3" number="14.4.4">
<h3>
<span class="header-section-number">14.4.4</span> Duplicate keys<a class="anchor" aria-label="anchor" href="#join-matches"><i class="fas fa-link"></i></a>
</h3>
<p>So far all the diagrams have assumed that the keys are unique.
But that’s not always the case.
This section explains what happens when the keys are not unique.
There are two possibilities:</p>
<ol style="list-style-type: decimal">
<li>
<p>One data frame has duplicate keys.
This is useful when you want to add in additional information as there is typically a one-to-many relationship.</p>
<div class="inline-figure"><img src="diagrams/join-one-to-many.png" title="Diagram describing a left join where one of the data frames (x) has duplicate keys. Data frame x is on the left, has 4 rows and 2 columns (key, val_x), and has the keys 1, 2, 2, and 1. Data frame y is on the right, has 2 rows and 2 columns (key, val_y), and has the keys 1 and 2. Left joining these two data frames yields a data frame with 4 rows (keys 1, 2, 2, and 1) and 3 columns (val_x, key, val_y). All values from x$val_x are carried along, values in y for key 1 and 2 are duplicated." alt="Diagram describing a left join where one of the data frames (x) has duplicate keys. Data frame x is on the left, has 4 rows and 2 columns (key, val_x), and has the keys 1, 2, 2, and 1. Data frame y is on the right, has 2 rows and 2 columns (key, val_y), and has the keys 1 and 2. Left joining these two data frames yields a data frame with 4 rows (keys 1, 2, 2, and 1) and 3 columns (val_x, key, val_y). All values from x$val_x are carried along, values in y for key 1 and 2 are duplicated." width="279" style="display: block; margin: auto;"></div>
<p>Note that I’ve put the key column in a slightly different position in the output.
This reflects that the key is a primary key in <code>y</code> and a foreign key in <code>x</code>.</p>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span>
  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_x</span>,
     <span class="fl">1</span>, <span class="st">"x1"</span>,
     <span class="fl">2</span>, <span class="st">"x2"</span>,
     <span class="fl">2</span>, <span class="st">"x3"</span>,
     <span class="fl">1</span>, <span class="st">"x4"</span>
<span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span>
  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_y</span>,
     <span class="fl">1</span>, <span class="st">"y1"</span>,
     <span class="fl">2</span>, <span class="st">"y2"</span>
<span class="op">)</span>
<span class="fu">left_join</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, by <span class="op">=</span> <span class="st">"key"</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 4 x 3&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;     &lt;U+2029&gt;[1mkey&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mval_x&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mval_y&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m     1 x1    y1   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m     2 x2    y2   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m     2 x3    y2   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m     1 x4    y1</span>NA</code></pre></div>
</li>
<li>
<p>Both data frames have duplicate keys.
This is usually an error because in neither data frame do the keys uniquely identify an observation.
When you join duplicated keys, you get all possible combinations, the Cartesian product:</p>
<div class="inline-figure"><img src="diagrams/join-many-to-many.png" title="Diagram describing a left join where both data frames (x and y) have duplicate keys. Data frame x is on the left, has 4 rows and 2 columns (key, val_x), and has the keys 1, 2, 2, and 3. Data frame y is on the right, has 4 rows and 2 columns (key, val_y), and has the keys 1, 2, 2, and 3 as well. Left joining these two data frames yields a data frame with 6 rows (keys 1, 2, 2, 2, 2, and 3) and 3 columns (key, val_x, val_y). All values from both datasets are included." alt="Diagram describing a left join where both data frames (x and y) have duplicate keys. Data frame x is on the left, has 4 rows and 2 columns (key, val_x), and has the keys 1, 2, 2, and 3. Data frame y is on the right, has 4 rows and 2 columns (key, val_y), and has the keys 1, 2, 2, and 3 as well. Left joining these two data frames yields a data frame with 6 rows (keys 1, 2, 2, 2, 2, and 3) and 3 columns (key, val_x, val_y). All values from both datasets are included." width="342" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span>
  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_x</span>,
     <span class="fl">1</span>, <span class="st">"x1"</span>,
     <span class="fl">2</span>, <span class="st">"x2"</span>,
     <span class="fl">2</span>, <span class="st">"x3"</span>,
     <span class="fl">3</span>, <span class="st">"x4"</span>
<span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span>
  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_y</span>,
     <span class="fl">1</span>, <span class="st">"y1"</span>,
     <span class="fl">2</span>, <span class="st">"y2"</span>,
     <span class="fl">2</span>, <span class="st">"y3"</span>,
     <span class="fl">3</span>, <span class="st">"y4"</span>
<span class="op">)</span>
<span class="fu">left_join</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, by <span class="op">=</span> <span class="st">"key"</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 6 x 3&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;     &lt;U+2029&gt;[1mkey&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mval_x&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mval_y&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m     1 x1    y1   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m     2 x2    y2   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m     2 x2    y3   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m     2 x3    y2   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m     2 x3    y3   </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m     3 x4    y4</span>NA</code></pre></div>
</li>
</ol>
</div>
<div id="join-by" class="section level3" number="14.4.5">
<h3>
<span class="header-section-number">14.4.5</span> Defining the key columns<a class="anchor" aria-label="anchor" href="#join-by"><i class="fas fa-link"></i></a>
</h3>
<p>So far, the pairs of data frames have always been joined by a single variable, and that variable has the same name in both data frames.
That constraint was encoded by <code>by = "key"</code>.
You can use other values for <code>by</code> to connect the data frames in other ways:</p>
<ul>
<li>
<p>The default, <code>by = NULL</code>, uses all variables that appear in both data frames, the so called <strong>natural</strong> join.
For example, the flights and weather data frames match on their common variables: <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code> and <code>origin</code>.</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights2</span> <span class="op">%&gt;%</span> 
  <span class="fu">left_join</span><span class="op">(</span><span class="va">weather</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = c("year", "month", "day", "hour", "origin")</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 336,776 x 18&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdest&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mtemp&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mdewp&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mhumid&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    IAH   N14228  UA       39.0  28.0  64.4</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 LGA    IAH   N24211  UA       39.9  25.0  54.8</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    MIA   N619AA  AA       39.0  27.0  61.6</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    BQN   N804JB  B6       39.0  27.0  61.6</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     6 LGA    ATL   N668DN  DL       39.9  25.0  54.8</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    ORD   N39463  UA       39.0  28.0  64.4</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 336,770 more rows, and 7 more variables: &lt;U+2029&gt;[1mwind_dir&lt;U+2029&gt;[22m &lt;dbl&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mwind_speed&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mwind_gust&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mprecip&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mpressure&lt;U+2029&gt;[22m &lt;dbl&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mvisib&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mtime_hour&lt;U+2029&gt;[22m &lt;dttm&gt;&lt;U+2029&gt;[39m</span>NA</code></pre></div>
</li>
<li>
<p>A character vector, <code>by = "x"</code>.
This is like a natural join, but uses only some of the common variables.
For example, <code>flights</code> and <code>planes</code> have <code>year</code> variables, but they mean different things so we only want to join by <code>tailnum</code>.</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights2</span> <span class="op">%&gt;%</span> 
  <span class="fu">left_join</span><span class="op">(</span><span class="va">planes</span>, by <span class="op">=</span> <span class="st">"tailnum"</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 336,776 x 16&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[1myear.x&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdest&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m &lt;U+2029&gt;[1myear.y&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mtype&lt;U+2029&gt;[22m             </span>NA<span class="co">#&gt;    &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m    &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m            </span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m   &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    IAH   N14228  UA        &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m999 Fixed wing multi~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m   &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 LGA    IAH   N24211  UA        &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m998 Fixed wing multi~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m   &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    MIA   N619AA  AA        &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m990 Fixed wing multi~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m   &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    BQN   N804JB  B6        &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m012 Fixed wing multi~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m   &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     6 LGA    ATL   N668DN  DL        &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m991 Fixed wing multi~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m   &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    ORD   N39463  UA        &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m012 Fixed wing multi~</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 336,770 more rows, and 6 more variables: &lt;U+2029&gt;[1mmanufacturer&lt;U+2029&gt;[22m &lt;chr&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mmodel&lt;U+2029&gt;[22m &lt;chr&gt;, &lt;U+2029&gt;[1mengines&lt;U+2029&gt;[22m &lt;int&gt;, &lt;U+2029&gt;[1mseats&lt;U+2029&gt;[22m &lt;int&gt;, &lt;U+2029&gt;[1mspeed&lt;U+2029&gt;[22m &lt;int&gt;, &lt;U+2029&gt;[1mengine&lt;U+2029&gt;[22m &lt;chr&gt;&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<p>Note that the <code>year</code> variables (which appear in both input data frames, but are not constrained to be equal) are disambiguated in the output with a suffix.</p>
</li>
<li>
<p>A named character vector: <code>by = c("a" = "b")</code>.
This will match variable <code>a</code> in data frame <code>x</code> to variable <code>b</code> in data frame <code>y</code>.
The variables from <code>x</code> will be used in the output.</p>
<p>For example, if we want to draw a map we need to combine the flights data with the airports data which contains the location (<code>lat</code> and <code>lon</code>) of each airport.
Each flight has an origin and destination <code>airport</code>, so we need to specify which one we want to join to:</p>
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights2</span> <span class="op">%&gt;%</span> 
  <span class="fu">left_join</span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dest"</span> <span class="op">=</span> <span class="st">"faa"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 336,776 x 15&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdest&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mname&lt;U+2029&gt;[22m      &lt;U+2029&gt;[1mlat&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mlon&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1malt&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    IAH   N14228  UA      George~  30.0 -&lt;U+2029&gt;[31m95&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m3&lt;U+2029&gt;[39m    97</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 LGA    IAH   N24211  UA      George~  30.0 -&lt;U+2029&gt;[31m95&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m3&lt;U+2029&gt;[39m    97</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    MIA   N619AA  AA      Miami ~  25.8 -&lt;U+2029&gt;[31m80&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m3&lt;U+2029&gt;[39m     8</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    BQN   N804JB  B6      &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m       &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m    &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m      &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     6 LGA    ATL   N668DN  DL      Hartsf~  33.6 -&lt;U+2029&gt;[31m84&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m026</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    ORD   N39463  UA      Chicag~  42.0 -&lt;U+2029&gt;[31m87&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m9&lt;U+2029&gt;[39m   668</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 336,770 more rows, and 3 more variables: &lt;U+2029&gt;[1mtz&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mdst&lt;U+2029&gt;[22m &lt;chr&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mtzone&lt;U+2029&gt;[22m &lt;chr&gt;&lt;U+2029&gt;[39m</span>NA<span class="va">flights2</span> <span class="op">%&gt;%</span> 
  <span class="fu">left_join</span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"origin"</span> <span class="op">=</span> <span class="st">"faa"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 336,776 x 15&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdest&lt;U+2029&gt;[22m  &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mname&lt;U+2029&gt;[22m      &lt;U+2029&gt;[1mlat&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mlon&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1malt&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m  &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    IAH   N14228  UA      Newark~  40.7 -&lt;U+2029&gt;[31m74&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m2&lt;U+2029&gt;[39m    18</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 LGA    IAH   N24211  UA      La Gua~  40.8 -&lt;U+2029&gt;[31m73&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m9&lt;U+2029&gt;[39m    22</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    MIA   N619AA  AA      John F~  40.6 -&lt;U+2029&gt;[31m73&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m8&lt;U+2029&gt;[39m    13</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 JFK    BQN   N804JB  B6      John F~  40.6 -&lt;U+2029&gt;[31m73&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m8&lt;U+2029&gt;[39m    13</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     6 LGA    ATL   N668DN  DL      La Gua~  40.8 -&lt;U+2029&gt;[31m73&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m9&lt;U+2029&gt;[39m    22</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1     5 EWR    ORD   N39463  UA      Newark~  40.7 -&lt;U+2029&gt;[31m74&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m.&lt;U+2029&gt;[39m&lt;U+2029&gt;[31m2&lt;U+2029&gt;[39m    18</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 336,770 more rows, and 3 more variables: &lt;U+2029&gt;[1mtz&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mdst&lt;U+2029&gt;[22m &lt;chr&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mtzone&lt;U+2029&gt;[22m &lt;chr&gt;&lt;U+2029&gt;[39m</span>NA</code></pre></div>
</li>
</ul>
</div>
<div id="exercises-25" class="section level3" number="14.4.6">
<h3>
<span class="header-section-number">14.4.6</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-25"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Compute the average delay by destination, then join on the <code>airports</code> data frame so you can show the spatial distribution of delays.
Here’s an easy way to draw a map of the United States:</p>
<div class="sourceCode" id="cb251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airports</span> <span class="op">%&gt;%</span>
  <span class="fu">semi_join</span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"faa"</span> <span class="op">=</span> <span class="st">"dest"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">borders</span><span class="op">(</span><span class="st">"state"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>(Don’t worry if you don’t understand what <code>semi_join()</code> does — you’ll learn about it next.)</p>
<p>You might want to use the <code>size</code> or <code>colour</code> of the points to display the average delay for each airport.</p>
</li>
<li><p>Add the location of the origin <em>and</em> destination (i.e. the <code>lat</code> and <code>lon</code>) to <code>flights</code>.</p></li>
<li><p>Is there a relationship between the age of a plane and its delays?</p></li>
<li><p>What weather conditions make it more likely to see a delay?</p></li>
<li><p>What happened on June 13 2013?
Display the spatial pattern of delays, and then use Google to cross-reference with the weather.</p></li>
</ol>
</div>
<div id="other-implementations" class="section level3" number="14.4.7">
<h3>
<span class="header-section-number">14.4.7</span> Other implementations<a class="anchor" aria-label="anchor" href="#other-implementations"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/merge.html">base::merge()</a></code> can perform all four types of mutating join:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>dplyr</th>
<th>merge</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>inner_join(x, y)</code></td>
<td><code><a href="https://rdrr.io/r/base/merge.html">merge(x, y)</a></code></td>
</tr>
<tr class="even">
<td><code>left_join(x, y)</code></td>
<td><code><a href="https://rdrr.io/r/base/merge.html">merge(x, y, all.x = TRUE)</a></code></td>
</tr>
<tr class="odd">
<td><code>right_join(x, y)</code></td>
<td>
<code><a href="https://rdrr.io/r/base/merge.html">merge(x, y, all.y = TRUE)</a></code>,</td>
</tr>
<tr class="even">
<td><code>full_join(x, y)</code></td>
<td><code><a href="https://rdrr.io/r/base/merge.html">merge(x, y, all.x = TRUE, all.y = TRUE)</a></code></td>
</tr>
</tbody>
</table></div>
<p>The advantages of the specific dplyr verbs is that they more clearly convey the intent of your code: the difference between the joins is really important but concealed in the arguments of <code><a href="https://rdrr.io/r/base/merge.html">merge()</a></code>.
dplyr’s joins are considerably faster and don’t mess with the order of the rows.</p>
<p>SQL is the inspiration for dplyr’s conventions, so the translation is straightforward:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>dplyr</th>
<th>SQL</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>inner_join(x, y, by = "z")</code></td>
<td><code>SELECT * FROM x INNER JOIN y USING (z)</code></td>
</tr>
<tr class="even">
<td><code>left_join(x, y, by = "z")</code></td>
<td><code>SELECT * FROM x LEFT OUTER JOIN y USING (z)</code></td>
</tr>
<tr class="odd">
<td><code>right_join(x, y, by = "z")</code></td>
<td><code>SELECT * FROM x RIGHT OUTER JOIN y USING (z)</code></td>
</tr>
<tr class="even">
<td><code>full_join(x, y, by = "z")</code></td>
<td><code>SELECT * FROM x FULL OUTER JOIN y USING (z)</code></td>
</tr>
</tbody>
</table></div>
<p>Note that “INNER” and “OUTER” are optional, and often omitted.</p>
<p>Joining different variables between the data frames, e.g. <code>inner_join(x, y, by = c("a" = "b"))</code> uses a slightly different syntax in SQL: <code>SELECT * FROM x INNER JOIN y ON x.a = y.b</code>.
As this syntax suggests, SQL supports a wider range of join types than dplyr because you can connect the data frames using constraints other than equality (sometimes called non-equijoins).</p>
</div>
</div>
<div id="filtering-joins" class="section level2" number="14.5">
<h2>
<span class="header-section-number">14.5</span> Filtering joins<a class="anchor" aria-label="anchor" href="#filtering-joins"><i class="fas fa-link"></i></a>
</h2>
<p>Filtering joins match observations in the same way as mutating joins, but affect the observations, not the variables.
There are two types:</p>
<ul>
<li>
<code>semi_join(x, y)</code> <strong>keeps</strong> all observations in <code>x</code> that have a match in <code>y</code>.</li>
<li>
<code>anti_join(x, y)</code> <strong>drops</strong> all observations in <code>x</code> that have a match in <code>y</code>.</li>
</ul>
<p>Semi-joins are useful for matching filtered summary data frames back to the original rows.
For example, imagine you’ve found the top ten most popular destinations:</p>
<div class="sourceCode" id="cb252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">top_dest</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">dest</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">top_dest</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 10 x 2&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[1mdest&lt;U+2029&gt;[22m      &lt;U+2029&gt;[1mn&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m ORD   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m&lt;U+2029&gt;[4m7&lt;U+2029&gt;[24m283</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m ATL   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m&lt;U+2029&gt;[4m7&lt;U+2029&gt;[24m215</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m LAX   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m&lt;U+2029&gt;[4m6&lt;U+2029&gt;[24m174</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m BOS   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m&lt;U+2029&gt;[4m5&lt;U+2029&gt;[24m508</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m MCO   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m&lt;U+2029&gt;[4m4&lt;U+2029&gt;[24m082</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m CLT   &lt;U+2029&gt;[4m1&lt;U+2029&gt;[24m&lt;U+2029&gt;[4m4&lt;U+2029&gt;[24m064</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 4 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<p>Now you want to find each flight that went to one of those destinations.
You could construct a filter yourself:</p>
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">%in%</span> <span class="va">top_dest</span><span class="op">$</span><span class="va">dest</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 141,145 x 19&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdep_time&lt;U+2029&gt;[22m &lt;U+2029&gt;[1msched_dep_time&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdep_delay&lt;U+2029&gt;[22m &lt;U+2029&gt;[1marr_time&lt;U+2029&gt;[22m &lt;U+2029&gt;[1msched_arr_time&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m    &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m          &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m     &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m    &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m          &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      542            540         2      923            850</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      554            600        -&lt;U+2029&gt;[31m6&lt;U+2029&gt;[39m      812            837</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      554            558        -&lt;U+2029&gt;[31m4&lt;U+2029&gt;[39m      740            728</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      555            600        -&lt;U+2029&gt;[31m5&lt;U+2029&gt;[39m      913            854</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      557            600        -&lt;U+2029&gt;[31m3&lt;U+2029&gt;[39m      838            846</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      558            600        -&lt;U+2029&gt;[31m2&lt;U+2029&gt;[39m      753            745</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 141,139 more rows, and 11 more variables: &lt;U+2029&gt;[1marr_delay&lt;U+2029&gt;[22m &lt;dbl&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m &lt;chr&gt;, &lt;U+2029&gt;[1mflight&lt;U+2029&gt;[22m &lt;int&gt;, &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;chr&gt;, &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m &lt;chr&gt;, &lt;U+2029&gt;[1mdest&lt;U+2029&gt;[22m &lt;chr&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mair_time&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mdistance&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mminute&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mtime_hour&lt;U+2029&gt;[22m &lt;dttm&gt;&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<p>But it’s difficult to extend that approach to multiple variables.
For example, imagine that you’d found the 10 days with highest average delays.
How would you construct the filter statement that used <code>year</code>, <code>month</code>, and <code>day</code> to match it back to <code>flights</code>?</p>
<p>Instead you can use a semi-join, which connects the two data frames like a mutating join, but instead of adding new columns, only keeps the rows in <code>x</code> that have a match in <code>y</code>:</p>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights</span> <span class="op">%&gt;%</span> 
  <span class="fu">semi_join</span><span class="op">(</span><span class="va">top_dest</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = "dest"</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 141,145 x 19&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;    &lt;U+2029&gt;[1myear&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mmonth&lt;U+2029&gt;[22m   &lt;U+2029&gt;[1mday&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdep_time&lt;U+2029&gt;[22m &lt;U+2029&gt;[1msched_dep_time&lt;U+2029&gt;[22m &lt;U+2029&gt;[1mdep_delay&lt;U+2029&gt;[22m &lt;U+2029&gt;[1marr_time&lt;U+2029&gt;[22m &lt;U+2029&gt;[1msched_arr_time&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m    &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m          &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m     &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m    &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m          &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      542            540         2      923            850</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      554            600        -&lt;U+2029&gt;[31m6&lt;U+2029&gt;[39m      812            837</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      554            558        -&lt;U+2029&gt;[31m4&lt;U+2029&gt;[39m      740            728</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      555            600        -&lt;U+2029&gt;[31m5&lt;U+2029&gt;[39m      913            854</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      557            600        -&lt;U+2029&gt;[31m3&lt;U+2029&gt;[39m      838            846</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m  &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m013     1     1      558            600        -&lt;U+2029&gt;[31m2&lt;U+2029&gt;[39m      753            745</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 141,139 more rows, and 11 more variables: &lt;U+2029&gt;[1marr_delay&lt;U+2029&gt;[22m &lt;dbl&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mcarrier&lt;U+2029&gt;[22m &lt;chr&gt;, &lt;U+2029&gt;[1mflight&lt;U+2029&gt;[22m &lt;int&gt;, &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m &lt;chr&gt;, &lt;U+2029&gt;[1morigin&lt;U+2029&gt;[22m &lt;chr&gt;, &lt;U+2029&gt;[1mdest&lt;U+2029&gt;[22m &lt;chr&gt;,&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m#   &lt;U+2029&gt;[1mair_time&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mdistance&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mhour&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mminute&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mtime_hour&lt;U+2029&gt;[22m &lt;dttm&gt;&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<p>Graphically, a semi-join looks like this:</p>
<div class="inline-figure"><img src="diagrams/join-semi.png" title="Diagram of a semi join. Data frame x is on the left and has two columns (key and val_x) with keys 1, 2, and 3. Diagram y is on the right and also has two columns (key and val_y) with keys 1, 2, and 4. Semi joining these two results in a data frame with two rows and two columns (key and val_x), with keys 1 and 2 (the only keys that match between the two data frames)." alt="Diagram of a semi join. Data frame x is on the left and has two columns (key and val_x) with keys 1, 2, and 3. Diagram y is on the right and also has two columns (key and val_y) with keys 1, 2, and 4. Semi joining these two results in a data frame with two rows and two columns (key and val_x), with keys 1 and 2 (the only keys that match between the two data frames)." width="307" style="display: block; margin: auto;"></div>
<p>Only the existence of a match is important; it doesn’t matter which observation is matched.
This means that filtering joins never duplicate rows like mutating joins do:</p>
<div class="inline-figure"><img src="diagrams/join-semi-many.png" title="Diagram of a semi join with data frames with duplicated keys. Data frame x is on the left and has two columns (key and val_x) with keys 1, 2, 2, and 3. Diagram y is on the right and also has two columns (key and val_y) with keys 1, 2, 2, and 3 as well. Semi joining these two results in a data frame with four rows and two columns (key and val_x), with keys 1, 2, 2, and 3 (the matching keys, each appearing as many times as they do in x)." alt="Diagram of a semi join with data frames with duplicated keys. Data frame x is on the left and has two columns (key and val_x) with keys 1, 2, 2, and 3. Diagram y is on the right and also has two columns (key and val_y) with keys 1, 2, 2, and 3 as well. Semi joining these two results in a data frame with four rows and two columns (key and val_x), with keys 1, 2, 2, and 3 (the matching keys, each appearing as many times as they do in x)." width="312" style="display: block; margin: auto;"></div>
<p>The inverse of a semi-join is an anti-join.
An anti-join keeps the rows that <em>don’t</em> have a match:</p>
<div class="inline-figure"><img src="diagrams/join-anti.png" title="Diagram of an anti join. Data frame x is on the left and has two columns (key and val_x) with keys 1, 2, and 3. Diagram y is on the right and also has two columns (key and val_y) with keys 1, 2, and 4. Anti joining these two results in a data frame with one row and two columns (key and val_x), with keys 3 only (the only key in x that is not in y)." alt="Diagram of an anti join. Data frame x is on the left and has two columns (key and val_x) with keys 1, 2, and 3. Diagram y is on the right and also has two columns (key and val_y) with keys 1, 2, and 4. Anti joining these two results in a data frame with one row and two columns (key and val_x), with keys 3 only (the only key in x that is not in y)." width="307" style="display: block; margin: auto;"></div>
<p>Anti-joins are useful for diagnosing join mismatches.
For example, when connecting <code>flights</code> and <code>planes</code>, you might be interested to know that there are many <code>flights</code> that don’t have a match in <code>planes</code>:</p>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flights</span> <span class="op">%&gt;%</span>
  <span class="fu">anti_join</span><span class="op">(</span><span class="va">planes</span>, by <span class="op">=</span> <span class="st">"tailnum"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">tailnum</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 722 x 2&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[1mtailnum&lt;U+2029&gt;[22m     &lt;U+2029&gt;[1mn&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;chr&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;int&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m &lt;U+2029&gt;[31mNA&lt;U+2029&gt;[39m       &lt;U+2029&gt;[4m2&lt;U+2029&gt;[24m512</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m N725MQ    575</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m N722MQ    513</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m4&lt;U+2029&gt;[39m N723MQ    507</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m5&lt;U+2029&gt;[39m N713MQ    483</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m6&lt;U+2029&gt;[39m N735MQ    396</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 716 more rows&lt;U+2029&gt;[39m</span>NA</code></pre></div>
<div id="exercises-26" class="section level3" number="14.5.1">
<h3>
<span class="header-section-number">14.5.1</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-26"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>What does it mean for a flight to have a missing <code>tailnum</code>?
What do the tail numbers that don’t have a matching record in <code>planes</code> have in common?
(Hint: one variable explains ~90% of the problems.)</p></li>
<li><p>Filter flights to only show flights with planes that have flown at least 100 flights.</p></li>
<li><p>Combine <code>fueleconomy::vehicles</code> and <code>fueleconomy::common</code> to find only the records for the most common models.</p></li>
<li><p>Find the 48 hours (over the course of the whole year) that have the worst delays.
Cross-reference it with the <code>weather</code> data.
Can you see any patterns?</p></li>
<li><p>What does <code>anti_join(flights, airports, by = c("dest" = "faa"))</code> tell you?
What does <code>anti_join(airports, flights, by = c("faa" = "dest"))</code> tell you?</p></li>
<li><p>You might expect that there’s an implicit relationship between plane and airline, because each plane is flown by a single airline.
Confirm or reject this hypothesis using the tools you’ve learned above.</p></li>
</ol>
</div>
</div>
<div id="join-problems" class="section level2" number="14.6">
<h2>
<span class="header-section-number">14.6</span> Join problems<a class="anchor" aria-label="anchor" href="#join-problems"><i class="fas fa-link"></i></a>
</h2>
<p>The data you’ve been working with in this chapter has been cleaned up so that you’ll have as few problems as possible.
Your own data is unlikely to be so nice, so there are a few things that you should do with your own data to make your joins go smoothly.</p>
<ol style="list-style-type: decimal">
<li>
<p>Start by identifying the variables that form the primary key in each data frame.
You should usually do this based on your understanding of the data, not empirically by looking for a combination of variables that give a unique identifier.
If you just look for variables without thinking about what they mean, you might get (un)lucky and find a combination that’s unique in your current data but the relationship might not be true in general.</p>
<p>For example, the altitude and longitude uniquely identify each airport, but they are not good identifiers!</p>
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airports</span> <span class="op">%&gt;%</span> <span class="fu">count</span><span class="op">(</span><span class="va">alt</span>, <span class="va">lon</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 0 x 3&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m# ... with 3 variables: &lt;U+2029&gt;[1malt&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mlon&lt;U+2029&gt;[22m &lt;dbl&gt;, &lt;U+2029&gt;[1mn&lt;U+2029&gt;[22m &lt;int&gt;&lt;U+2029&gt;[39m</span>NA</code></pre></div>
</li>
<li><p>Check that none of the variables in the primary key are missing.
If a value is missing then it can’t identify an observation!</p></li>
<li>
<p>Check that your foreign keys match primary keys in another data frame.
The best way to do this is with an <code>anti_join()</code>.
It’s common for keys not to match because of data entry errors.
Fixing these is often a lot of work.</p>
<p>If you do have missing keys, you’ll need to be thoughtful about your use of inner vs. outer joins, carefully considering whether or not you want to drop rows that don’t have a match.</p>
</li>
</ol>
<p>Be aware that simply checking the number of rows before and after the join is not sufficient to ensure that your join has gone smoothly.
If you have an inner join with duplicate keys in both data frames, you might get unlucky as the number of dropped rows might exactly equal the number of duplicated rows!</p>
</div>
<div id="set-operations" class="section level2" number="14.7">
<h2>
<span class="header-section-number">14.7</span> Set operations<a class="anchor" aria-label="anchor" href="#set-operations"><i class="fas fa-link"></i></a>
</h2>
<p>The final type of two-table verb are the set operations.
Generally, I use these the least frequently, but they are occasionally useful when you want to break a single complex filter into simpler pieces.
All these operations work with a complete row, comparing the values of every variable.
These expect the <code>x</code> and <code>y</code> inputs to have the same variables, and treat the observations like sets:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/sets.html">intersect(x, y)</a></code>: return only observations in both <code>x</code> and <code>y</code>.</li>
<li>
<code><a href="https://rdrr.io/r/base/sets.html">union(x, y)</a></code>: return unique observations in <code>x</code> and <code>y</code>.</li>
<li>
<code><a href="https://rdrr.io/r/base/sets.html">setdiff(x, y)</a></code>: return observations in <code>x</code>, but not in <code>y</code>.</li>
</ul>
<p>Given this simple data:</p>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df1</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span>
  <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,
   <span class="fl">1</span>,  <span class="fl">1</span>,
   <span class="fl">2</span>,  <span class="fl">1</span>
<span class="op">)</span>
<span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span>
  <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,
   <span class="fl">1</span>,  <span class="fl">1</span>,
   <span class="fl">1</span>,  <span class="fl">2</span>
<span class="op">)</span></code></pre></div>
<p>The four possibilities are:</p>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 1 x 2&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;       &lt;U+2029&gt;[1mx&lt;U+2029&gt;[22m     &lt;U+2029&gt;[1my&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m     1     1</span>NA<span class="co"># Note that we get 3 rows, not 4</span>
<span class="fu"><a href="https://rdrr.io/r/base/sets.html">union</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 3 x 2&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;       &lt;U+2029&gt;[1mx&lt;U+2029&gt;[22m     &lt;U+2029&gt;[1my&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m     1     1</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m2&lt;U+2029&gt;[39m     2     1</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m3&lt;U+2029&gt;[39m     1     2</span>NA<span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 1 x 2&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;       &lt;U+2029&gt;[1mx&lt;U+2029&gt;[22m     &lt;U+2029&gt;[1my&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m     2     1</span>NA<span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">df2</span>, <span class="va">df1</span><span class="op">)</span>
<span class="co">#&gt; &lt;U+2029&gt;[90m# A tibble: 1 x 2&lt;U+2029&gt;[39m</span>NA<span class="co">#&gt;       &lt;U+2029&gt;[1mx&lt;U+2029&gt;[22m     &lt;U+2029&gt;[1my&lt;U+2029&gt;[22m</span>NA<span class="co">#&gt;   &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m &lt;U+2029&gt;[3m&lt;U+2029&gt;[90m&lt;dbl&gt;&lt;U+2029&gt;[39m&lt;U+2029&gt;[23m</span>NA<span class="co">#&gt; &lt;U+2029&gt;[90m1&lt;U+2029&gt;[39m     1     2</span>NA</code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="tibbles.html"><span class="header-section-number">13</span> Tibbles</a></div>
<div class="next"><a href="vector-tools.html"><span class="header-section-number">15</span> Vector tools</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#relational-data"><span class="header-section-number">14</span> Relational data</a></li>
<li>
<a class="nav-link" href="#introduction-7"><span class="header-section-number">14.1</span> Introduction</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#prerequisites-7"><span class="header-section-number">14.1.1</span> Prerequisites</a></li></ul>
</li>
<li>
<a class="nav-link" href="#nycflights13-relational"><span class="header-section-number">14.2</span> nycflights13</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#exercises-23"><span class="header-section-number">14.2.1</span> Exercises</a></li></ul>
</li>
<li>
<a class="nav-link" href="#keys"><span class="header-section-number">14.3</span> Keys</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#exercises-24"><span class="header-section-number">14.3.1</span> Exercises</a></li></ul>
</li>
<li>
<a class="nav-link" href="#mutating-joins"><span class="header-section-number">14.4</span> Mutating joins</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#understanding-joins"><span class="header-section-number">14.4.1</span> Understanding joins</a></li>
<li><a class="nav-link" href="#inner-join"><span class="header-section-number">14.4.2</span> Inner join</a></li>
<li><a class="nav-link" href="#outer-join"><span class="header-section-number">14.4.3</span> Outer joins</a></li>
<li><a class="nav-link" href="#join-matches"><span class="header-section-number">14.4.4</span> Duplicate keys</a></li>
<li><a class="nav-link" href="#join-by"><span class="header-section-number">14.4.5</span> Defining the key columns</a></li>
<li><a class="nav-link" href="#exercises-25"><span class="header-section-number">14.4.6</span> Exercises</a></li>
<li><a class="nav-link" href="#other-implementations"><span class="header-section-number">14.4.7</span> Other implementations</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#filtering-joins"><span class="header-section-number">14.5</span> Filtering joins</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#exercises-26"><span class="header-section-number">14.5.1</span> Exercises</a></li></ul>
</li>
<li><a class="nav-link" href="#join-problems"><span class="header-section-number">14.6</span> Join problems</a></li>
<li><a class="nav-link" href="#set-operations"><span class="header-section-number">14.7</span> Set operations</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/r4ds/blob/master/relational-data.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/r4ds/edit/master/relational-data.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R for Data Science (2e)</strong>" was written by Hadley Wickham and Garrett Grolemund. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
